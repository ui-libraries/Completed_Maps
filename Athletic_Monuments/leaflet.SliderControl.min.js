L.Control.SliderControl=L.Control.extend({options:{position:"bottomleft",layers:null,timeAttribute:"time",isEpoch:!1,startTimeIdx:0,timeStrLength:19,maxValue:-1,minValue:0,showAllOnStart:!1,markers:null,range:!1,follow:!1,alwaysShowDate:!1,rezoom:null},initialize:function(o){L.Util.setOptions(this,o),this._layer=this.options.layer},extractTimestamp:function(o,t){return t.isEpoch&&(o=new Date(parseInt(o)).toString()),o.substr(t.startTimeIdx,t.startTimeIdx+t.timeStrLength)},setPosition:function(o){var t=this._map;return t&&t.removeControl(this),this.options.position=o,t&&t.addControl(this),this.startSlider(),this},onAdd:function(o){this.options.map=o;var t=L.DomUtil.create("div","slider",this._container);$(t).append('<div id="leaflet-slider" style="width:200px"><div class="ui-slider-handle"></div><div id="slider-timestamp" style="width:200px; margin-top:-30px; background-color:#FFFFFF; text-align:center; border-radius:5px;"></div></div>'),$(t).mousedown(function(){o.dragging.disable()}),$(document).mouseup(function(){o.dragging.enable(),(e.range||!e.alwaysShowDate)&&$("#slider-timestamp").html("")});var e=this.options;if(this.options.markers=[],this._layer){var i=0;this._layer.eachLayer(function(o){e.markers[i]=o,++i}),e.maxValue=i-1,this.options=e}else console.log("Error: You have to specify a layer via new SliderControl({layer: your_layer});");return t},onRemove:function(o){for(i=this.options.minValue;i<=this.options.maxValue;i++)o.removeLayer(this.options.markers[i]);$("#leaflet-slider").remove()},startSlider:function(){_options=this.options,_extractTimestamp=this.extractTimestamp;var o=_options.minValue;for(_options.showAllOnStart&&(o=_options.maxValue,_options.range?_options.values=[_options.minValue,_options.maxValue]:_options.value=_options.maxValue),$("#leaflet-slider").slider({range:_options.range,value:_options.value,values:_options.values,min:_options.minValue,max:_options.maxValue,step:1,slide:function(o,t){var e=_options.map,i=L.featureGroup();if(_options.markers[t.value]){void 0!==_options.markers[t.value].feature?_options.markers[t.value].feature.properties[_options.timeAttribute]?_options.markers[t.value]&&$("#slider-timestamp").html(_extractTimestamp(_options.markers[t.value].feature.properties[_options.timeAttribute],_options)):console.error("Time property "+_options.timeAttribute+" not found in data"):_options.markers[t.value].options[_options.timeAttribute]?_options.markers[t.value]&&$("#slider-timestamp").html(_extractTimestamp(_options.markers[t.value].options[_options.timeAttribute],_options)):console.error("Time property "+_options.timeAttribute+" not found in data");var r;for(r=_options.minValue;r<=_options.maxValue;r++)_options.markers[r]&&e.removeLayer(_options.markers[r]);if(_options.range)for(r=t.values[0];r<=t.values[1];r++)_options.markers[r]&&(e.addLayer(_options.markers[r]),i.addLayer(_options.markers[r]));else if(_options.follow)for(r=t.value-_options.follow+1;r<=t.value;r++)_options.markers[r]&&(e.addLayer(_options.markers[r]),i.addLayer(_options.markers[r]));else for(r=_options.minValue;r<=t.value;r++)_options.markers[r]&&(e.addLayer(_options.markers[r]),i.addLayer(_options.markers[r]))}_options.rezoom&&e.fitBounds(i.getBounds(),{maxZoom:_options.rezoom})}}),!_options.range&&_options.alwaysShowDate&&$("#slider-timestamp").html(_extractTimeStamp(_options.markers[o].feature.properties[_options.timeAttribute],_options)),i=_options.minValue;i<=o;i++)_options.map.addLayer(_options.markers[i])}}),L.control.sliderControl=function(o){return new L.Control.SliderControl(o)};
